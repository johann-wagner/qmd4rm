---
title: "Untitled"
format: docx
editor: visual
---

## 

```{r}

df <- tibble(
  quintile = rep(c(1,1,3,4,5), 2),
  rurality = c(rep("Regional",5), rep("Urban", 5)),
  count = rep(c(1251.12,5125.23,6162.12,9949.0125,1661), 2),
  n_and_pct = rep(c("15.6 (12.2%)","1 (0.1%)","51.5 (85.2%)", "102 (115%)", "223 100%"), 2),
  n_n = rep(c("15.2 1", "61.4 1", "61.0 2", "32.4 4.2", "95.2 15.2"), 2),
  pct = rep(c("0.12","0.56"),5)
)

grab_value <- function(
    data, # The input data frame
    criteria, # The filter criteria to identify a singular row
    column, # The column the value is in
    unit = "n", # The units for the value, either n, percent, or a custom value
    digits = 1.1, # The number of digits to round to
    suppress = FALSE, # Suppress values smaller than
    allowable_range = FALSE
){
  value <- data |> 
    dplyr::filter({{ criteria }}) |> 
    dplyr::pull({{ column }})
  
  # Check that value is not empty
  if(length(value) == 0 | is.null(value)){
    stop("No values returned by criteria")
  }
  # Check there are not multiple values returned
  if(length(value) > 1){
    stop("More than one row was returned by criteria")
  }
  
  if(class(value) == "character") {
    if(stringr::str_count(value,"\\d+?(\\.\\d+)") > 1){
      stop("Multiple possible values detected in cell")
    } else {
      value <- as.numeric(stringr::str_extract(value, "\\d+?(\\.\\d+)"))
    }
  }
  
  if(unit == "n"){
    # Round and apply number formatting
    return(scales::label_number_auto(accuracy = digits)(value))
  } else if(unit == "percent") {
    # Format as a percentage
    return(scales::label_percent(accuracy = digits)(value))
  } else {
    # Treat as numeric and append the unit
    return(str_c(value, unit, sep = " "))
  }
}


grab_value(
  data = df,
  criteria = (rurality == 'Regional' & quintile == 4),
  column = pct,
  unit = "kcal",
  digits = 4
)
```

```{r}

library(dplyr)
library(stringr)
library(scales)

interpret_sentence <- function(
    value,                    # output of grab_value(), e.g. "12.3%" or "0.12"
    context = NULL,           # optional text: "of Regional quintile-1 participants"
    higher_is_better = TRUE,  # whether a high % is "good"
    digits = 1,               # number of decimal places in printed %
    cutpoints = c(0.05, 0.25, 0.75, 0.95) # thresholds for verbal labels)
)
{
   # --- INTERNAL capitaliser ---------------------------------------------
  ucfirst <- function(x) {
    paste0(toupper(substr(x, 1, 1)), substr(x, 2, nchar(x)))
  }
  
  # --- 1. Get numeric proportion from value -----------------------------
  if (length(value) != 1L || is.na(value)) {
    stop("interpret_pct_sentence() expects a single non-missing value.")
  }
  
  # value might be "12.3%", "0.123", 0.123, 12.3, etc.
  if (is.character(value)) {
    num <- as.numeric(str_extract(value, "-?\\d+\\.?\\d*"))
  } else {
    num <- as.numeric(value)
  }
  
  if (is.na(num)) {
    stop("Could not extract a numeric value from 'value'.")
  }
  
  # If looks like 0-1, treat as proportion; if >1, assume percentage (0-100)
  p <- if (num > 1) num / 100 else num
  
  # --- 2. Translate proportion into qualitative phrase ------------------
  cp <- cutpoints
  phrase <- dplyr::case_when(
    p <  cp[1] ~ if (higher_is_better) "a very small proportion" else "almost none",
    p <  cp[2] ~ "a minority",
    p <  cp[3] ~ "around half",
    p <  cp[4] ~ "a clear majority",
    TRUE       ~ if (higher_is_better) "almost all" else "the vast majority"
  )
  
  # --- 3. Build percentage string ---------------------------------------
  pct_string <- scales::percent(p, accuracy = 1 / 10^digits)
  
  # --- 4. Build final sentence ------------------------------------------
  phrase_cap <- ucfirst(phrase)
  
  if (!is.null(context) && nzchar(context)) {
    out <- paste0(phrase_cap, " (", pct_string, ") ", context, ".")
  } else {
    out <- paste0(phrase_cap, " (", pct_string, ").")
  }
  
  out
}


interpret_sentence(
  grab_value(df, quintile == 4 & rurality == "Regional", pct,
             unit = "percent", digits = 4),
  context = "of Regional quintile-4 participants", 
  higher_is_better = FALSE,
  digits = 1
)
    


```
